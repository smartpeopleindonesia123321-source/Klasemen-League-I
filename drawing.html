<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRAWING CENTER | STABLE MODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --dark: #0a0a0a; --white: #ffffff; --blue: #00f2ff; --red: #ff4d4d; }
        body { background: #111; font-family: 'Kanit', sans-serif; margin: 0; color: var(--white); padding: 10px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; background: #1a1a1a; padding: 20px; border-radius: 20px; border: 3px solid var(--gold); box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); text-align: center; box-sizing: border-box; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; text-align: left; }
        .full-col { grid-column: span 2; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 11px; color: var(--gold); font-weight: bold; text-transform: uppercase; }
        input, select { background: #252525; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-family: 'Kanit'; font-size: 14px; width: 100%; box-sizing: border-box; }
        select:disabled { opacity: 0.7; color: var(--gold); border: 1px solid var(--gold); cursor: not-allowed; }
        .absen-container { background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .absen-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #ccc; }
        #draw-list { display: flex; flex-direction: column; gap: 8px; margin: 20px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; min-height: 50px; transition: 0.5s ease; }
        .is-blind { filter: blur(20px) grayscale(1); pointer-events: none; user-select: none; }
        .draw-item { background: #252525; padding: 12px 15px; border-radius: 8px; border-left: 5px solid var(--gold); display: flex; justify-content: space-between; align-items: center; font-size: 14px; text-align: left; }
        .rank { font-weight: 900; color: var(--gold); margin-right: 10px; }
        button { padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; font-family: 'Kanit'; width: 100%; margin-bottom: 10px; }
        #btn-shuffle { background: var(--gold); color: black; }
        #btn-lock { background: var(--red); color: white; }
        #btn-wa { background: #25d366; color: white; display: none; text-decoration: none; align-items: center; justify-content: center; padding: 15px; border-radius: 8px; font-weight: bold; }
        .status-lock { color: var(--blue); margin-top: 15px; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--gold); margin: 0 0 5px 0; font-size: 24px;">üé∞ DRAWING CENTER</h1>
    <div id="sync-status" style="font-size: 10px; color: #555; margin-bottom: 10px;">Menghubungkan...</div>

    <div class="input-grid">
        <div class="input-group full-col">
            <label>Pilih Match</label>
            <select id="match-select" onchange="updateMatchDetails()"></select>
        </div>
        <div class="input-group"><label>Tanggal</label><input type="text" id="match-date" readonly></div>
        <div class="input-group"><label>Jam</label><input type="text" id="start-time" readonly></div>
        <div class="input-group full-col"><label>Tim</label><input type="text" id="teams" readonly></div>
        <div class="input-group"><label>Durasi (Mnt)</label><input type="text" id="duration" readonly></div>
        <div class="input-group"><label>Saksi</label><input type="text" id="witness-name" readonly></div>
        <div class="input-group full-col">
            <label>Status Pemain</label>
            <div class="absen-container" id="absen-list-display"></div>
        </div>
    </div>

    <div id="draw-list" class="is-blind"></div>

    <div id="controls">
        <button id="btn-shuffle" onclick="shuffleData()">üîÑ ACAK URUTAN (<span id="count">0</span>)</button>
        <button id="btn-lock" onclick="lockResult()">üîí FIX & BUKA HASIL</button>
        <a id="btn-wa" href="#" onclick="shareToWA()">üì≤ KIRIM KE WHATSAPP</a>
    </div>

    <div id="status" class="status-lock">‚úÖ URUTAN SAH & TERKUNCI</div>
</div>

<script>
    const drawingSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4v_ziMtwhRpQxS5ZnIbO9olIrUlzAAx8X5kS_Yr-Mv_GqDqSsg4Lc-1YNugRqElvUClbXnsf5gu12/pub?gid=353274036&single=true&output=csv';
    const playerMaster = ["Dandi", "Asep", "Rizal", "Aries", "Ikmal", "Regi", "Yanti", "Erni", "Dicky", "Maya"];
    
    let allMatchesData = [];
    let shuffleCount = 0;
    let currentList = [];
    let isLocked = false;
    let globalAbsent = [];

    function calculateSchedule(startTimeStr, index, durationMinutes) {
        if(!startTimeStr || startTimeStr === "-" || startTimeStr === "") return { start: "", end: "", display: "" };
        let [hours, minutes] = startTimeStr.split(':').map(Number);
        let startTotalMinutes = hours * 60 + minutes;
        
        let offset = (parseInt(durationMinutes) + 1) * index;
        let matchStartMinutes = startTotalMinutes + offset;
        let matchEndMinutes = matchStartMinutes + parseInt(durationMinutes);

        const formatTime = (totalMin) => {
            let h = Math.floor(totalMin / 60) % 24;
            let m = totalMin % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        let s = formatTime(matchStartMinutes);
        let e = formatTime(matchEndMinutes);

        return { start: s, end: e, display: `(${s}-${e})` };
    }

    async function syncData() {
        try {
            const res = await fetch(`${drawingSheetUrl}&nocache=${new Date().getTime()}`);
            const csv = await res.text();
            const rows = csv.split('\n').slice(1).map(r => r.split(',').map(c => c.trim().replace(/"/g, '')));
            allMatchesData = rows.filter(r => r[0] !== "");

            if (rows.some(row => row[7] === "RESET")) {
                localStorage.clear();
                location.reload();
                return;
            }

            if (document.getElementById('match-select').options.length === 0) {
                populateDropdown();
                checkSavedState();
            }
            
            const selectEl = document.getElementById('match-select');
            const currentIdx = selectEl.value;
            const sheetLock = allMatchesData[currentIdx] ? allMatchesData[currentIdx][7] === "LOCK" : false;
            
            if (sheetLock || isLocked) {
                selectEl.disabled = true;
            } else {
                selectEl.disabled = false;
            }
            document.getElementById('sync-status').innerText = "‚úÖ Koneksi Stabil";
        } catch (e) { console.error("Sync error"); }
    }

    function populateDropdown() {
        const select = document.getElementById('match-select');
        select.innerHTML = "";
        allMatchesData.forEach((data, index) => {
            let opt = document.createElement('option');
            opt.value = index; opt.text = data[0]; select.appendChild(opt);
        });
        const savedIdx = localStorage.getItem('saved_match_idx');
        if (savedIdx !== null && allMatchesData[savedIdx]) select.value = savedIdx;
        updateMatchDetails();
    }

    function checkSavedState() {
        if (localStorage.getItem('is_locked') === 'true') {
            isLocked = true;
            currentList = JSON.parse(localStorage.getItem('saved_list')) || [];
            shuffleCount = localStorage.getItem('saved_count') || 0;
            document.getElementById('count').innerText = shuffleCount;
            const sIdx = localStorage.getItem('saved_match_idx');
            if(sIdx !== null) document.getElementById('match-select').value = sIdx;
            updateMatchDetails();
            applyFinalReveal();
        }
    }

    function updateMatchDetails() {
        const idx = document.getElementById('match-select').value;
        if (idx === "" || !allMatchesData[idx]) return;
        const data = allMatchesData[idx];
        document.getElementById('match-date').value = data[1] || "-";
        document.getElementById('teams').value = data[2] || "-";
        document.getElementById('start-time').value = data[3] || "-";
        document.getElementById('duration').value = data[4] || "-";
        document.getElementById('witness-name').value = data[5] || "-";
        globalAbsent = data[6] ? data[6].split(';').map(n => n.trim()) : [];
        renderAbsentStatus();
        if(isLocked) renderList(); 
    }

    function renderAbsentStatus() {
        document.getElementById('absen-list-display').innerHTML = playerMaster.map(p => {
            const isAbs = globalAbsent.includes(p);
            return `<div class="absen-item" style="color:${isAbs ? '#ff4d4d' : '#00ff88'}">${isAbs ? '‚ùå' : '‚úÖ'} ${p}</div>`;
        }).join('');
    }

    function shuffleData() {
        if (isLocked) return;
        document.getElementById('draw-list').classList.add('is-blind');
        let active = shuffleArray(playerMaster.filter(p => !globalAbsent.includes(p)));
        let abs = shuffleArray([...globalAbsent]);
        currentList = [...active, ...abs];
        shuffleCount++;
        document.getElementById('count').innerText = shuffleCount;
        renderList();
    }

    function renderList() {
        if (currentList.length === 0) return;
        const sTime = document.getElementById('start-time').value;
        const dur = document.getElementById('duration').value;
        document.getElementById('draw-list').innerHTML = currentList.map((name, index) => {
            const isAbs = globalAbsent.includes(name);
            const sched = calculateSchedule(sTime, index, dur);
            const timeDisplay = isAbs ? "" : sched.display;
            return `<div class="draw-item" style="${isAbs ? 'opacity:0.5; border-left-color:red;' : ''}">
                <span>
                    <span class="rank">#${index+1}</span> 
                    <b>${name.toUpperCase()}</b> 
                    <span style="color:var(--gold); font-size:12px; margin-left:5px;">${timeDisplay}</span> 
                    ${isAbs ? '(ABSEN)' : ''}
                </span>
            </div>`;
        }).join('');
    }

    function lockResult() {
        if (currentList.length === 0) return alert("Klik ACAK dulu!");
        if (confirm("KUNCI HASIL?")) {
            isLocked = true;
            localStorage.setItem('saved_list', JSON.stringify(currentList));
            localStorage.setItem('saved_count', shuffleCount);
            localStorage.setItem('saved_match_idx', document.getElementById('match-select').value);
            localStorage.setItem('is_locked', 'true');
            applyFinalReveal();
        }
    }

    function applyFinalReveal() {
        document.getElementById('draw-list').classList.remove('is-blind');
        document.getElementById('btn-shuffle').style.display = "none";
        document.getElementById('btn-lock').style.display = "none";
        document.getElementById('match-select').disabled = true;
        document.getElementById('status').style.display = "block";
        document.getElementById('btn-wa').style.display = "flex";
        renderList();
    }

    function shuffleArray(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    function shareToWA() {
        const sel = document.getElementById('match-select');
        const m = sel.options[sel.selectedIndex].text;
        const dt = document.getElementById('match-date').value;
        const jm = document.getElementById('start-time').value;
        const tm = document.getElementById('teams').value;
        const dr = document.getElementById('duration').value;
        const ws = document.getElementById('witness-name').value;
    
        let msg = `*${m.toUpperCase()}*%0A`;
        msg += `*${tm.toUpperCase()}*%0A%0A`;
        msg += `üìÖ Tanggal: ${dt}%0A`;
        msg += `‚öñÔ∏è Saksi: ${ws}%0A`;
        msg += `üé≤ Acakan: ${shuffleCount}x%0A%0A`;
        msg += `*HASIL DRAWING & JADWAL:*%0A`;
        
        // Kita ambil langsung dari variabel currentList yang ada di memory
        if (currentList && currentList.length > 0) {
            currentList.forEach((n, i) => {
                const isAbs = globalAbsent.includes(n);
                const sched = calculateSchedule(jm, i, dr);
                
                if (isAbs) {
                    msg += `${i+1}. ${n.toUpperCase()} (ABSEN)%0A`;
                } else {
                    // Pakai tanda titik dua biar pas di-copas ke Excel jadi kolom sendiri
                    msg += `${i+1}. ${n.toUpperCase()} : ${sched.start} - ${sched.end}%0A`;
                }
            });
        } else {
            msg += `(Data tidak ditemukan, silakan acak ulang)%0A`;
        }
        
        msg += `%0A_Generated by Drawing Center_`;
        window.open(`https://wa.me/?text=${msg}`, '_blank');
    }

    window.onload = function() {
        syncData(); 
        setInterval(syncData, 5000);
    };
</script>
</body>
</html>




